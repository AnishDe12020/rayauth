import{useEffect as Q,useMemo as G,useState as R}from"react";import{useCookies as J}from"react-cookie";import O from"axios";var y="http://localhost:8080",d="http://localhost:3000/wallet";import{EventEmitter as V}from"sweet-event-emitter";var h=class{constructor(e){this.id=e==null?void 0:e.id,this.createdAt=e==null?void 0:e.createdAt,this.updatedAt=e==null?void 0:e.updatedAt,this.email=e==null?void 0:e.email,this.address=e==null?void 0:e.address,this.avatar=e==null?void 0:e.address,this.event=new V,this.state=e==null?void 0:e.store}sendTransaction(e,s,t){try{console.log("waw");let o=new URL(`${d}/send-transaction`);o.searchParams.append("txn",e.serialize().toString()),o.searchParams.append("options",(t==null?void 0:t.toString())||String({data:"empty"})),o.searchParams.append("isgasless",String(s))}catch(o){throw new Error("Can't execute send transaction")}}signTransaction(e){try{console.log(this),console.log(this.state),console.log("waw");let s=new URL(`${d}/sign-transaction`);s.searchParams.append("txn",e.serialize({requireAllSignatures:!1}).toString()),this.state.setSrc(s.toString()),this.state.setVisible(!0)}catch(s){throw console.error(s),new Error("Can't execute send transaction")}}signAllTransactions(e){try{new URL(`${d}/sign-all-transactions`).searchParams.append("txns",e.map(t=>t.serialize().toString()).toString())}catch(s){throw new Error("Can't execute signing of all transactions")}}signMessage(e,s,t){try{let o=new URL(`${d}/sign-message`);o.searchParams.append("msg",e),o.searchParams.append("address",this.address||"NOT-FOUND"),o.searchParams.append("isgasless",String(s))}catch(o){throw new Error("Can't execute signing of message")}}toggleIframe(e,s){var t;(t=this.state)==null||t.setSrc(e),this.state.setVisible(s)}async testSign(e){try{let s=new URL(`${d}?msg=${e}`);s.searchParams.append("txn",e),this.toggleIframe(s.toString(),!0);let t=await this.loopTxnData();return this.toggleIframe(d,!1),t}catch(s){throw new Error("Can't execute send transaction")}}async loopTxnData(){let e=new Date().getTime(),s=null;for(console.log("pre loob",s);s==null||e-new Date().getTime()>=15e3;)console.log("loop running"),window.onmessage=function(t){console.log(t.data),t.data.type=="signtransac"&&console.log(!0),t.data.type=="txnData"&&(console.log(!0),console.log("loop data",t.data),s=t.data,console.log("data be like",s))},await $(1e3);return s}};function $(r){return new Promise(e=>setTimeout(e,r))}async function P(r,e){let s=await O.get(`${y}/user`,{headers:{Authorization:`Bearer ${r}`}});console.log(s.data);let t=new h({id:s.data.id,createdAt:s.data.createdAt,updatedAt:s.data.updatedAt,email:s.data.email,address:s.data.address,avatar:s.data.avatar,store:e});return console.log("constructor",t),t}import{create as z}from"zustand";var T=z(r=>({count:1,isHidden:!0,src:d,txnData:{},setTxnData:e=>r(s=>({txnData:e})),setVisible:e=>r(s=>({isHidden:!e})),setSrc:e=>r(s=>({src:e}))}));import{createContext as _,useContext as j}from"react";function W(r,e){return`${r} returned \`undefined\`. Seems you forgot to wrap component within ${e}`}function C(r={}){let{name:e,strict:s=!0,hookName:t="useContext",providerName:o="Provider",errorMessage:a}=r,m=_(void 0);m.displayName=e;function u(){var c;let p=j(m);if(!p&&s){let i=new Error(a!=null?a:W(t,o));throw i.name="ContextError",(c=Error.captureStackTrace)==null||c.call(Error,i,u),i}return p}return[m.Provider,u,m]}import Ee,{useEffect as Re}from"react";import{EventEmitter as q}from"sweet-event-emitter";var v=class{constructor(){this.event=new q}eventEmitter(){return this.event}onSignTransac(e){this.event.on("signTransac",e)}},b=new v;var[Ue,k]=C();import{clusterApiUrl as Y,Connection as F,Transaction as X}from"@solana/web3.js";function E(r){return new Promise(e=>setTimeout(e,r))}import L from"hex-array";function U(){let r=k(),e=r.cookieName||"jwt-rayauth",s=T(),[t,o]=R(null),[a,m]=R(!1),[u,p,c]=J([e]),i=G(()=>new F(Y("devnet")),[]);Q(()=>{(async()=>{if(console.log("CHAL RHA"),m(!0),!u[e]){m(!1);return}console.log("YAHA BHI CHAL RHA");let n=await P(u[e],s);console.log("USER CHAL RHA"),o(n),m(!1),console.log("PURA CHAL RHA",n.state)})()},[u]);let f=()=>{console.log("RUNNING CALLBACK");let n=new URLSearchParams(window.location.search).get("jwt");n&&u[e]&&(console.log("exists",u[e]),c(e),console.log(p(e,n))),n&&!u[e]&&console.log(p(e,n.toString()))},S=l=>{let n=new URL(`${y}/auth/${l||r.provider}`);n.searchParams.append("cb",r.callbackUrl),n.searchParams.append("id",r.clientId),console.log(n.toString()),window.location.replace(n.toString())},D=()=>{c(e)};async function A(l){try{console.log(t),console.log(t==null?void 0:t.state),console.log("waw");let n=new URL(`${d}/sign-transaction`);if(l instanceof X&&l.recentBlockhash===null){let H=(await i.getLatestBlockhash("finalized")).blockhash;l.recentBlockhash=H}n.searchParams.append("txn",L.toString(l.serialize({requireAllSignatures:!1}))),console.log("hex",L.toString(l.serialize({requireAllSignatures:!1}))),console.log("url",n.toString()),t==null||t.state.setSrc(n.toString()),t==null||t.state.setVisible(!0);let g=await B();return t==null||t.state.setVisible(!1),g}catch(n){throw console.error(n),new Error("Can't execute send transaction")}}let N=async l=>{try{let n=await A(l);return console.log("signed",n),await i.sendRawTransaction(n.serialize())}catch(n){throw console.error(n),new Error("Can't execute send transaction")}};async function B(){let l=new Date().getTime(),n=null;for(console.log("pre loob",n);n==null||l-new Date().getTime()>=15e3;)console.log("loop running"),window.onmessage=function(g){console.log(g.data),g.data.type=="signtransac"&&console.log(!0),g.data.type=="txnData"&&(console.log(!0),console.log("loop data",g.data),n=g.data,console.log("data be like",n))},await E(1e3);return n}return{signIn:S,signOut:D,user:t,isLoading:a,handleCallback:f,walletListener:b,signTransaction:A,sendTransaction:N}}import{clusterApiUrl as Z,Connection as ee,Keypair as I,PublicKey as K}from"@solana/web3.js";import{AnchorProvider as te,BN as se,Program as ne}from"@project-serum/anchor";import{useEffect as re,useMemo as x}from"react";import{Buffer as w}from"buffer";var M={version:"0.1.0",name:"rayauth_session",instructions:[{name:"addSessionKey",accounts:[{name:"payer",isMut:!0,isSigner:!0},{name:"user",isMut:!1,isSigner:!0},{name:"sessionKey",isMut:!1,isSigner:!0},{name:"sessionKeyPda",isMut:!0,isSigner:!1},{name:"systemProgram",isMut:!1,isSigner:!1}],args:[{name:"expiresAt",type:{option:"i64"}}]},{name:"revokeSessionKey",accounts:[{name:"sessionKeyPda",isMut:!0,isSigner:!1},{name:"user",isMut:!0,isSigner:!1},{name:"systemProgram",isMut:!1,isSigner:!1}],args:[]}],accounts:[{name:"sessionKey",type:{kind:"struct",fields:[{name:"user",type:"publicKey"},{name:"sessionKey",type:"publicKey"},{name:"expiresAt",type:"i64"}]}}],events:[{name:"SessionKeyAdded",fields:[{name:"user",type:"publicKey",index:!1},{name:"sessionKey",type:"publicKey",index:!1},{name:"expiresAt",type:"i64",index:!1}]},{name:"SessionKeyRevoked",fields:[{name:"user",type:"publicKey",index:!1},{name:"sessionKey",type:"publicKey",index:!1}]}],errors:[{code:6e3,name:"InvalidExpiresAt",msg:"Invalid expires at"}]};var oe="QMj41mN3j168KTuUWNrCgbSAYQ7o9QTaaSnT9gLvW9s",rt=()=>{let r=x(()=>new ee(Z("devnet")),[]),{user:e,signTransaction:s}=U();re(()=>{window.Buffer=w});let t=x(()=>{if(e!=null&&e.address)return{publicKey:new K(e.address),signTransaction:s,signAllTransactions:e.signAllTransactions}},[e]),o=x(()=>{if(t)return new te(r,t,{commitment:"confirmed"})},[r,t]);console.log("anchorWallet",t),console.log("anchorProvider",o);let a=x(()=>{if(o)return new ne(M,oe,o)},[o]);console.log("sessionProgram",a);let m=async(c=Math.floor(Date.now()/1e3)+3600)=>{if(!a){console.log("ched");return}let i=new I;console.log(i);let[f]=await K.findProgramAddress([w.from("session_key"),i.publicKey.toBuffer()],a.programId);console.log("doing tx");let S=await a.methods.addSessionKey(new se(c)).accounts({sessionKeyPda:f,sessionKey:i.publicKey,payer:t==null?void 0:t.publicKey,user:t==null?void 0:t.publicKey}).signers([i]).rpc();console.log("addSessionKeyIx",S),localStorage.setItem("sessionToken",JSON.stringify(i))},u=()=>{let c=localStorage.getItem("sessionToken");if(c)return I.fromSecretKey(w.from(JSON.parse(c).secretKey))};return{sessionProgram:a,addSessionToken:m,getSessionKeypair:u,revokeSessionToken:async()=>{if(!a)return;let c=u();if(!c)return;let[i]=await K.findProgramAddress([w.from("session_key"),c.publicKey.toBuffer()],a.programId),f=await a.methods.revokeSessionKey().accounts({sessionKeyPda:i,user:t==null?void 0:t.publicKey}).rpc();console.log("revokeSessionKeyTx",f)}}};export{oe as SESSION_PROGRAM_ID,U as useAuth,rt as useSessionProgram};
//# sourceMappingURL=index.mjs.map